<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯­éŸ³æ—¥ç¨‹åŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        .voice-button {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            margin: 30px auto;
            display: block;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .voice-button:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }
        
        .voice-button:active {
            transform: scale(0.95);
        }
        
        .voice-button.recording {
            animation: pulse 1.5s infinite;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
        
        .status {
            text-align: center;
            margin: 20px 0;
            min-height: 30px;
        }
        
        .status-text {
            color: #666;
            font-size: 1.1em;
        }
        
        .status-text.active {
            color: #667eea;
            font-weight: bold;
        }
        
        .conversation {
            margin-top: 30px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .message {
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.user {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        
        .message.assistant {
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
        }
        
        .message.error {
            background: #ffebee;
            border-left: 4px solid #f44336;
        }
        
        .message-label {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .message.user .message-label {
            color: #2196f3;
        }
        
        .message.assistant .message-label {
            color: #9c27b0;
        }
        
        .message.error .message-label {
            color: #f44336;
        }
        
        .message-text {
            color: #333;
            line-height: 1.5;
        }
        
        .loading {
            text-align: center;
            margin: 20px 0;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .instructions {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }
        
        .instructions h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .instructions ul {
            list-style-position: inside;
            color: #666;
        }
        
        .instructions li {
            margin: 8px 0;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ™ï¸ è¯­éŸ³æ—¥ç¨‹åŠ©æ‰‹</h1>
            <p>ç‚¹å‡»æŒ‰é’®å¼€å§‹è¯­éŸ³å¯¹è¯ï¼Œè‡ªåŠ¨ç®¡ç†æ‚¨çš„ Google æ—¥å†</p>
        </div>
        
        <button id="voiceButton" class="voice-button">
            <span id="buttonText">å¼€å§‹è¯­éŸ³å¯¹è¯</span>
        </button>
        
        <div class="status">
            <div id="statusText" class="status-text"></div>
        </div>
        
        <div id="loading" class="loading hidden">
            <div class="loading-spinner"></div>
            <p style="margin-top: 10px; color: #666;">å¤„ç†ä¸­...</p>
        </div>
        
        <div id="conversation" class="conversation"></div>
        
        <div class="instructions">
            <h3>ä½¿ç”¨è¯´æ˜</h3>
            <ul>
                <li>ç‚¹å‡»"å¼€å§‹è¯­éŸ³å¯¹è¯"æŒ‰é’®å¼€å§‹å½•éŸ³</li>
                <li>è¯´å‡ºæ‚¨çš„æ—¥ç¨‹å®‰æ’ï¼Œä¾‹å¦‚ï¼š"æ˜å¤©ä¸Šåˆ10ç‚¹åˆ°11ç‚¹ï¼Œå’ŒCEOä¼šè®®"</li>
                <li>ç‚¹å‡»"åœæ­¢å½•éŸ³"åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†å¹¶åˆ›å»ºæ—¥ç¨‹</li>
                <li>é¦–æ¬¡ä½¿ç”¨éœ€è¦æ‰‹åŠ¨ç™»å½• Google è´¦å·</li>
            </ul>
        </div>
    </div>
    
    <audio id="audioPlayer" style="display: none;"></audio>
    
    <script>
        let ws = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        
        const voiceButton = document.getElementById('voiceButton');
        const buttonText = document.getElementById('buttonText');
        const statusText = document.getElementById('statusText');
        const conversation = document.getElementById('conversation');
        const loading = document.getElementById('loading');
        const audioPlayer = document.getElementById('audioPlayer');
        
        // è¿æ¥ WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/voice`;
            
            console.log('æ­£åœ¨è¿æ¥ WebSocket:', wsUrl);
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('âœ… WebSocket è¿æ¥æˆåŠŸ');
                setStatus('å·²è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œç­‰å¾…æ¬¢è¿æ¶ˆæ¯...', false, true);
            };
            
            ws.onmessage = async (event) => {
                console.log('ğŸ“¨ æ”¶åˆ°æœåŠ¡å™¨æ¶ˆæ¯');
                const data = JSON.parse(event.data);
                console.log('æ¶ˆæ¯å†…å®¹:', data);
                handleServerMessage(data);
            };
            
            ws.onerror = (error) => {
                console.error('âŒ WebSocket é”™è¯¯:', error);
                setStatus('è¿æ¥é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', true);
            };
            
            ws.onclose = () => {
                console.log('ğŸ”Œ WebSocket è¿æ¥å…³é—­');
                setStatus('è¿æ¥å·²æ–­å¼€');
            };
        }
        
        // å¤„ç†æœåŠ¡å™¨æ¶ˆæ¯
        function handleServerMessage(data) {
            console.log('ğŸ” å¤„ç†æ¶ˆæ¯ç±»å‹:', data.type);
            
            switch(data.type) {
                case 'audio_response':
                    console.log('ğŸµ æ”¶åˆ°éŸ³é¢‘å“åº”');
                    hideLoading();
                    
                    // å…ˆæ˜¾ç¤ºæ–‡å­—
                    addMessage('assistant', data.text);
                    
                    // æ’­æ”¾éŸ³é¢‘
                    if (data.audio) {
                        console.log('ğŸ”Š å¼€å§‹æ’­æ”¾éŸ³é¢‘, éŸ³é¢‘é•¿åº¦:', data.audio.length);
                        playAudio(data.audio);
                    } else {
                        console.warn('âš ï¸ æ²¡æœ‰éŸ³é¢‘æ•°æ®');
                    }
                    
                    if (data.success) {
                        setStatus('æ—¥ç¨‹åˆ›å»ºæˆåŠŸï¼', false, true);
                    }
                    break;
                    
                case 'transcript':
                    console.log('ğŸ“ æ”¶åˆ°è¯­éŸ³è¯†åˆ«ç»“æœ:', data.text);
                    addMessage('user', data.text);
                    showLoading();
                    setStatus('æ­£åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚...', false, true);
                    break;
                    
                case 'status':
                    console.log('â„¹ï¸ çŠ¶æ€æ¶ˆæ¯:', data.message);
                    setStatus(data.message, false, true);
                    
                    // å¦‚æœçŠ¶æ€æ¶ˆæ¯åŒ…å«éŸ³é¢‘ï¼Œä¹Ÿå°è¯•æ’­æ”¾
                    if (data.audio) {
                        console.log('ğŸ”Š çŠ¶æ€æ¶ˆæ¯åŒ…å«éŸ³é¢‘ï¼Œå¼€å§‹æ’­æ”¾');
                        playAudio(data.audio);
                    }
                    break;
                    
                case 'error':
                    console.error('âŒ é”™è¯¯æ¶ˆæ¯:', data.message);
                    hideLoading();
                    addMessage('error', data.message);
                    setStatus('å¤„ç†å¤±è´¥', true);
                    
                    // å¦‚æœé”™è¯¯æ¶ˆæ¯åŒ…å«éŸ³é¢‘ï¼Œä¹Ÿæ’­æ”¾
                    if (data.audio) {
                        console.log('ğŸ”Š é”™è¯¯æ¶ˆæ¯åŒ…å«éŸ³é¢‘ï¼Œå¼€å§‹æ’­æ”¾');
                        playAudio(data.audio);
                    }
                    break;
                    
                default:
                    console.warn('âš ï¸ æœªçŸ¥æ¶ˆæ¯ç±»å‹:', data.type);
            }
        }
        
        // æ’­æ”¾éŸ³é¢‘
        function playAudio(base64Audio) {
            try {
                console.log('ğŸµ å‡†å¤‡æ’­æ”¾éŸ³é¢‘');
                console.log('éŸ³é¢‘æ•°æ®å‰20ä¸ªå­—ç¬¦:', base64Audio.substring(0, 20));
                
                const audioBlob = base64ToBlob(base64Audio, 'audio/mp3');
                console.log('âœ… Blob åˆ›å»ºæˆåŠŸï¼Œå¤§å°:', audioBlob.size, 'bytes');
                
                const audioUrl = URL.createObjectURL(audioBlob);
                console.log('âœ… Audio URL åˆ›å»ºæˆåŠŸ:', audioUrl);
                
                audioPlayer.src = audioUrl;
                
                // æ·»åŠ æ’­æ”¾äº‹ä»¶ç›‘å¬
                audioPlayer.onloadeddata = () => {
                    console.log('âœ… éŸ³é¢‘æ•°æ®åŠ è½½å®Œæˆ');
                };
                
                audioPlayer.onplay = () => {
                    console.log('â–¶ï¸ éŸ³é¢‘å¼€å§‹æ’­æ”¾');
                };
                
                audioPlayer.onended = () => {
                    console.log('â¹ï¸ éŸ³é¢‘æ’­æ”¾å®Œæˆ');
                    URL.revokeObjectURL(audioUrl);
                };
                
                audioPlayer.onerror = (e) => {
                    console.error('âŒ éŸ³é¢‘æ’­æ”¾é”™è¯¯:', e);
                    console.error('é”™è¯¯ä»£ç :', audioPlayer.error?.code);
                    console.error('é”™è¯¯æ¶ˆæ¯:', audioPlayer.error?.message);
                };
                
                // å¼€å§‹æ’­æ”¾
                const playPromise = audioPlayer.play();
                if (playPromise !== undefined) {
                    playPromise
                        .then(() => {
                            console.log('âœ… éŸ³é¢‘æ’­æ”¾æˆåŠŸå¯åŠ¨');
                        })
                        .catch(error => {
                            console.error('âŒ éŸ³é¢‘æ’­æ”¾å¤±è´¥:', error);
                        });
                }
            } catch (error) {
                console.error('âŒ æ’­æ”¾éŸ³é¢‘æ—¶å‡ºé”™:', error);
            }
        }
        
        // Base64 è½¬ Blob
        function base64ToBlob(base64, mimeType) {
            try {
                const byteCharacters = atob(base64);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                return new Blob([byteArray], {type: mimeType});
            } catch (error) {
                console.error('âŒ Base64 è½¬ Blob å¤±è´¥:', error);
                throw error;
            }
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°å¯¹è¯æ¡†
        function addMessage(type, text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const label = document.createElement('div');
            label.className = 'message-label';
            label.textContent = type === 'user' ? 'æ‚¨è¯´ï¼š' : 
                               type === 'assistant' ? 'åŠ©æ‰‹ï¼š' : 'é”™è¯¯ï¼š';
            
            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';
            textDiv.textContent = text;
            
            messageDiv.appendChild(label);
            messageDiv.appendChild(textDiv);
            conversation.insertBefore(messageDiv, conversation.firstChild);
            
            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            conversation.scrollTop = 0;
        }
        
        // è®¾ç½®çŠ¶æ€æ–‡æœ¬
        function setStatus(text, isError = false, isActive = false) {
            statusText.textContent = text;
            statusText.className = 'status-text';
            if (isActive) statusText.classList.add('active');
            if (isError) statusText.style.color = '#f44336';
        }
        
        // æ˜¾ç¤º/éšè—åŠ è½½åŠ¨ç”»
        function showLoading() {
            loading.classList.remove('hidden');
        }
        
        function hideLoading() {
            loading.classList.add('hidden');
        }
        
        // å¼€å§‹å½•éŸ³
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const arrayBuffer = await audioBlob.arrayBuffer();
                    const bytes = new Uint8Array(arrayBuffer);
                    const hexString = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
                    
                    // å‘é€éŸ³é¢‘åˆ°æœåŠ¡å™¨
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'audio_input',
                            audio: hexString
                        }));
                        setStatus('æ­£åœ¨è¯†åˆ«è¯­éŸ³...', false, true);
                    } else {
                        setStatus('è¿æ¥å·²æ–­å¼€ï¼Œè¯·åˆ·æ–°é¡µé¢', true);
                    }
                    
                    // åœæ­¢æ‰€æœ‰éŸ³é¢‘è½¨é“
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                isRecording = true;
                voiceButton.classList.add('recording');
                buttonText.textContent = 'å½•éŸ³ä¸­...ç‚¹å‡»åœæ­¢';
                setStatus('æ­£åœ¨å½•éŸ³...è¯·è¯´è¯', false, true);
                
            } catch (error) {
                console.error('å½•éŸ³å¤±è´¥:', error);
                setStatus('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®', true);
                addMessage('error', 'æ— æ³•è®¿é—®éº¦å…‹é£ã€‚è¯·ç¡®ä¿ï¼š\n1. å·²æˆäºˆéº¦å…‹é£æƒé™\n2. ä½¿ç”¨ HTTPS æˆ– localhost\n3. éº¦å…‹é£æœªè¢«å…¶ä»–åº”ç”¨å ç”¨');
            }
        }
        
        // åœæ­¢å½•éŸ³
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                voiceButton.classList.remove('recording');
                buttonText.textContent = 'å¼€å§‹è¯­éŸ³å¯¹è¯';
                setStatus('æ­£åœ¨å¤„ç†å½•éŸ³...', false, true);
                showLoading();
            }
        }
        
        // æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        voiceButton.addEventListener('click', () => {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                setStatus('æ­£åœ¨è¿æ¥æœåŠ¡å™¨...', false, true);
                connectWebSocket();
                setTimeout(() => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        if (isRecording) {
                            stopRecording();
                        } else {
                            startRecording();
                        }
                    } else {
                        setStatus('è¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', true);
                    }
                }, 1000);
            } else {
                if (isRecording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            }
        });
        
        // é¡µé¢åŠ è½½æ—¶è¿æ¥ WebSocket
        window.addEventListener('load', () => {
            console.log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡è¿æ¥ WebSocket');
            connectWebSocket();
        });
        
        // æ˜¾ç¤ºåˆå§‹åŒ–æ¶ˆæ¯
        console.log('ğŸš€ è¯­éŸ³æ—¥ç¨‹åŠ©æ‰‹å·²åŠ è½½');
    </script>
</body>
</html>